Sub MettreEnFormeAccueil()
    Dim ws As Worksheet
    Dim plageW As Range, plageG As Range
    Dim derniereLigne As Long

    ' Déterminer la feuille active (compatible avec toutes les feuilles sources)
    Set ws = ActiveSheet
    If Not EstFeuilleSource(ws) Then
        ' Si pas une feuille source, essayer "Accueil" par défaut
        On Error Resume Next
        Set ws = ThisWorkbook.Sheets("Accueil")
        On Error GoTo 0
        If ws Is Nothing Then Exit Sub
    End If

    ' Centrer tout le contenu de la feuille horizontalement et verticalement
    With ws.Cells
        .HorizontalAlignment = xlCenter
        .VerticalAlignment = xlCenter
    End With

    ' Trouver la dernière ligne utilisée
    derniereLigne = ws.Cells(ws.Rows.Count, "A").End(xlUp).Row

    ' Définir les plages concernées
    Set plageW = ws.Range("W7:W" & derniereLigne)
    Set plageG = ws.Range("G7:G" & derniereLigne)

    ' Supprimer les anciennes règles SEULEMENT pour les colonnes G et W (pas H)
    plageW.FormatConditions.Delete
    plageG.FormatConditions.Delete
    ' IMPORTANT : Ne pas supprimer les conditions de la colonne H (codes caisson)

    ' Appliquer mise en forme conditionnelle colonne W (texte contient "cm libres" ? fond rouge, texte blanc)
    With plageW.FormatConditions.Add(Type:=xlTextString, String:="cm libres", TextOperator:=xlContains)
        .Interior.Color = RGB(255, 0, 0)
        .Font.Color = RGB(255, 255, 255)
        .Font.Bold = True
    End With

    ' Appliquer mise en forme conditionnelle colonne G (>0 ? fond bleu clair, texte noir)
    With plageG.FormatConditions.Add(Type:=xlCellValue, Operator:=xlGreater, Formula1:="0")
        .Interior.Color = RGB(173, 216, 230) ' Bleu clair
        .Font.Color = RGB(0, 0, 0) ' Noir
    End With

    ' Rendre la colonne W visible si elle était masquée
    ws.Columns("W:W").Hidden = False
    ws.Columns("W:W").ColumnWidth = 15

    ' Coloration conditionnelle pour H6 et W6
    Call ColorerCellulesH6EtW6(ws)

    'MsgBox "Mise en forme conditionnelle appliquée avec succès.", vbInformation
End Sub

' =====================================================
' FONCTION : Coloration conditionnelle pour H6 et W6
' =====================================================

Sub ColorerCellulesH6EtW6(ws As Worksheet)
    Dim plageH As Range, plageW As Range
    Dim derniereLigne As Long
    Dim i As Long
    Dim rougeDetecteH As Boolean, rougeDetecteW As Boolean
    
    On Error Resume Next
    
    ' Trouver la dernière ligne avec des données
    derniereLigne = ws.Cells(ws.Rows.Count, "A").End(xlUp).Row
    
    ' Vérifier s'il y a des valeurs rouges dans la colonne H
    Set plageH = ws.Range("H7:H" & derniereLigne)
    rougeDetecteH = False
    For i = 7 To derniereLigne
        If ws.Cells(i, 8).Interior.Color = RGB(255, 0, 0) Then
            rougeDetecteH = True
            Exit For
        End If
    Next i
    
    ' Vérifier s'il y a des valeurs rouges dans la colonne W
    Set plageW = ws.Range("W7:W" & derniereLigne)
    rougeDetecteW = False
    For i = 7 To derniereLigne
        If ws.Cells(i, 23).Interior.Color = RGB(255, 0, 0) Then
            rougeDetecteW = True
            Exit For
        End If
    Next i
    
    ' Colorer H6 selon la présence de rouge dans la colonne H
    With ws.Range("H6")
        If rougeDetecteH Then
            .Interior.Color = RGB(255, 0, 0) ' Rouge
            .Font.Color = RGB(255, 255, 255) ' Texte blanc
        Else
            .Interior.Color = RGB(0, 255, 0) ' Vert
            .Font.Color = RGB(0, 0, 0) ' Texte noir
        End If
    End With
    
    ' Colorer W6 selon la présence de rouge dans la colonne W
    With ws.Range("W6")
        If rougeDetecteW Then
            .Interior.Color = RGB(255, 0, 0) ' Rouge
            .Font.Color = RGB(255, 255, 255) ' Texte blanc
        Else
            .Interior.Color = RGB(0, 255, 0) ' Vert
            .Font.Color = RGB(0, 0, 0) ' Texte noir
        End If
    End With
    
    On Error GoTo 0
End Sub
